<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.house.mapper.HouseMapper">

	<!-- 동+거래년도+거래월 별 아파트 실거래 정보 조회 -->
	<select id="getDealsByDong" parameterType="map"
		resultType="com.ssafy.house.model.HouseDealResponseDto">
		SELECT
		hi.apt_seq AS aptSeq,
		hi.apt_nm AS aptName,  <!-- alias로 필드 이름을 맞춤 -->
		hd.floor,
		hd.exclu_use_ar AS excluUseAr,  <!-- alias로 필드 이름을 맞춤 -->
		hi.umd_nm AS legalDong,  <!-- alias로 필드 이름을 맞춤 -->
		hd.deal_amount AS tradeAmount  <!-- alias로 필드 이름을 맞춤 -->
		FROM housedeals hd
		JOIN houseinfos hi ON hd.apt_seq = hi.apt_seq
		JOIN dongcodes dc ON hi.umd_nm = dc.dong_name
		WHERE dc.sido_name = #{sido}
		AND dc.gugun_name = #{gugun}
		AND dc.dong_name = #{dong}
		AND CONCAT(hi.sgg_cd, hi.umd_cd) = dc.dong_code
		<if test="year != null and year > 0">			
			AND hd.deal_year = #{year}
		</if>
		<if test="month != null and month > 0">
			AND hd.deal_month = #{month}
		</if>
	</select>

	<!-- 특정 아파트 이름으로 실거래 정보 조회 -->
	<select id="getDealsByAptName" parameterType="String"
		resultType="com.ssafy.house.model.HouseDealResponseDto">
		SELECT
		hi.apt_nm AS aptName,  <!-- alias로 필드 이름을 맞춤 -->
		hd.floor,
		hd.exclu_use_ar AS excluUseAr,  <!-- alias로 필드 이름을 맞춤 -->
		hi.umd_nm AS legalDong,  <!-- alias로 필드 이름을 맞춤 -->
		hd.deal_amount AS tradeAmount  <!-- alias로 필드 이름을 맞춤 -->
		FROM housedeals hd
		JOIN houseinfos hi ON hd.apt_seq = hi.apt_seq
		JOIN dongcodes dc ON hi.umd_nm = dc.dong_name
		WHERE hi.apt_nm = #{aptName}
	</select>
	
	<!-- aptSeq로 아파트 정보 조회 -->
	<select id="getHouseInfoByAptSeq" parameterType="string"
		resultType="com.ssafy.house.model.HouseInfoDto">
		SELECT
		apt_seq AS aptSeq,
		sgg_cd AS sggCd,
		umd_cd AS umdCd,
		umd_nm AS umdNm,
		jibun,
		road_nm_sgg_cd AS roadNmSggCd,
		road_nm AS roadNm,
		road_nm_bonbun AS roadNmBonbun,
		road_nm_bubun AS roadNmBubun,
		apt_nm AS aptNm,
		build_year AS buildYear,
		latitude,
		longitude
		FROM houseinfos
		WHERE apt_seq = #{aptSeq}
	</select>
	
	<!-- 동별 거래 년도 조회 -->
	<select id="getHouseDealYearByDong" parameterType="map"
		resultType="Integer">
		SELECT
		distinct(deal_year) AS deal_year
		FROM housedeals hd
		JOIN houseinfos hi ON hd.apt_seq = hi.apt_seq
		JOIN dongcodes dc ON hi.umd_nm = dc.dong_name
		WHERE dc.sido_name = #{sido}
		AND dc.gugun_name = #{gugun}
		AND dc.dong_name = #{dong}
		AND CONCAT(hi.sgg_cd, hi.umd_cd) = dc.dong_code
		ORDER BY deal_year;
	</select>
	
	<!-- 거래 년도 별 월 조회 -->
	<select id="getHouseDealMonthByYear" parameterType="map"
		resultType="Integer">
			SELECT
			distinct(deal_month) AS deal_month
			FROM housedeals hd
			JOIN houseinfos hi ON hd.apt_seq = hi.apt_seq
			JOIN dongcodes dc ON hi.umd_nm = dc.dong_name
			WHERE dc.sido_name =  #{sido}
			AND dc.gugun_name = #{gugun}
			AND dc.dong_name = #{dong}
			AND CONCAT(hi.sgg_cd, hi.umd_cd) = dc.dong_code
			AND hd.deal_year = #{year}
			ORDER BY deal_month;
	</select>
	
</mapper>
